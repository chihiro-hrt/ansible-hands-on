[↑目次に戻る](/README.md)
<br>
# 演習3.4　ALAXALA装置の設定情報をSmartCS経由で取得する

演習3.3でax_commandを使ってALAXALA装置から設定情報を取得するPlaybookを作成しました。    
作成したPlaybookの内容を一部変更して、SmartCS経由（コンソール経由）で同様の情報を取得するPlaybookを作成します。

## 目次
本演習では以下を行います。  
- STEP1.ログイン用、ログアウト用のPlaybookを作成する  
- STEP2.<code>ax_command</code>をSmartCS経由で動作させるように変更する
- STEP3.作成した3つのPlaybookを1回のコマンドで実行する(includeの利用)  


## 演習概要図

> あとで描く

### STEP1. ログイン用、ログアウト用のPlaybookを作成する。

通常のモジュール(ax_command等)は、SSH経由で装置にログインして情報を取得しますが、コンソール経由で接続をする場合  
- コンソールからのログイン  
- コンソールからのログアウト  
の処理を行う必要があります。

演習3.1で作成したPlaybookと同様 コンソール経由でオペレーションした場合、  
ログイン時は以下のような入出力、Playbookとなります。  

■ログイン時  
＜入出力＞
```
login: alaxala
Password: 

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230> 
```
＜Playbook＞
```
---
- name: '3-4 step1 login'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      recvchar:
      - 'login: '
      - 'Password: '
      - 'AX2230> '
      sendchar:
      - 'alaxala'
      - 'secret2230'
```

ログアウト時は以下のような入出力、Playbookとなります。  


■ログアウト時  
＜入出力＞
```
AX2230> exit

login: 
```
＜Playbook＞
```
---
- name: '3-1 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      recvchar:
      - 'login: '
      - 'AX2230> '
      sendchar:
      - 'exit'
      - 'exit'
```

### STEP2. ax_commandをSmartCS経由で動作させるように変更する

実際の処理部分のPlaybookを作成します。  
演習3.3の<code>ax_command</code>とtask部分は同じですが、<code>hosts</code>と<code>vars</code>に指定する値が変わります。

Playbook  
```
---
- name: '3-4 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301

  tasks:
  - name: "ax_command"
    ax_command:
      commands:
      - show version
      - show ip route
      - show vlan 1
      - show memory summary 
      - show ntp-client

```
解説  
- hosts: NS2250  
SmartCS経由で接続を行うため、接続先をNS2250と指定します。
- ansible_user: portX 
SmartCS経由で接続を行うため、ログインユーザを変更します。  
SmartCSのポートアクセス用ユーザ名<code>port1</code>を指定します。  
- ansible_password: portX  
SmartCS経由で接続を行うため、ログインユーザのパスワードを変更します。  
SmartCSのポートアクセス用ユーザのパスワード<code>port1</code>を指定します。  
- ansible_port: 9301  
SmartCS経由で接続を行うため、ポート番号を指定します。  


### STEP3. 作成した3つのPlaybookを1回のコマンドで実行する(includeの利用)  

STEP1、STEP2 で作成した3つのPlaybookを1回のコマンドで実行できるようなPlaybookを作成します。  
複数のPlaybookを集約して実行する為、<code>import_playbook</code>を利用します。
https://docs.ansible.com/ansible/latest/modules/import_playbook_module.html

Playbook
```
---
- name: "login"
  import_playbook: 3.4_step1_login.yml

- name: "ax_command via console"
  import_playbook: 3.4_step2_operation.yml

- name: "logout"
  import_playbook: 3.4_step1_logout.yml
```

■参考  

<code>ax_command</code>をSSH経由で取得した結果、  
<code>ax_command</code>をコンソール経由で取得した結果  
をそれぞれ比較してみます。


演習3.3で取得した<code>ax_command</code>を実行した結果の<code>stdout_lines</code>

```
    "stdout_lines": [
        [
            "Date 1980/04/10 11:01:55 UTC",
            "Model: AX2230S-24T",
            "S/W: OS-LT4 Ver. 2.10 (Build:01)",
            "H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]"
        ],
        [
            "Date 1980/04/10 11:01:55 UTC",
            "Total: 2",
            "Destination         Nexthop           Interface    Protocol ",
            "0.0.0.0/0           10.5.28.1         VLAN0001     Static",
            "10.5.28.0/24        10.5.28.111       VLAN0001     Connected"
        ],
        [
            "Date 1980/04/10 11:01:55 UTC",
            "VLAN counts: 1",
            "VLAN ID: 1     Type: Port based  Status: Up",
            "  Learning: On",
            "  BPDU Forwarding:        EAPOL Forwarding: ",
            "  Router Interface Name: VLAN0001",
            "  IP Address: 10.5.28.111/24",
            "  Source MAC address: 0012.e26a.015c(System)",
            "  Description: VLAN0001",
            "  Spanning Tree: None(-)",
            "  AXRP RING ID:       AXRP VLAN group:",
            "  IGMP snooping:      MLD snooping: ",
            "  Untagged(28)  : 0/1-28",
            "  Tagged(0)     :"
        ],
        [
            "Date 1980/04/10 11:01:55 UTC",
            "",
            "    Physical memory = 131072KB(128.00MB)",
            "    Used     memory = 118631KB(115.85MB)",
            "    Free     memory =  12441KB( 12.15MB)"
        ],
        [
            "Date 1980/04/10 11:01:55 UTC",
            " Last NTP Status",
            "  There is no updating information.",
            "",
            " Activate NTP Client",
            "  NTP-Server : ---, Source-Address : ---",
            "  Mode : Command",
            "",
            " NTP Execute History(Max 10 entry)",
            "  There is no history information."
        ]
    ]
```

演習3.4 STEP3で取得した <code>ax_command</code>を実行した結果の<code>stdout_lines</code>

```
    "stdout_lines": [
        [
            "Date 1980/04/10 11:02:27 UTC",
            "Model: AX2230S-24T",
            "S/W: OS-LT4 Ver. 2.10 (Build:01)",
            "H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]"
        ],
        [
            "Date 1980/04/10 11:02:27 UTC",
            "Total: 2",
            "Destination         Nexthop           Interface    Protocol ",
            "0.0.0.0/0           10.5.28.1         VLAN0001     Static",
            "10.5.28.0/24        10.5.28.111       VLAN0001     Connected"
        ],
        [
            "Date 1980/04/10 11:02:28 UTC",
            "VLAN counts: 1",
            "VLAN ID: 1     Type: Port based  Status: Up",
            "  Learning: On",
            "  BPDU Forwarding:        EAPOL Forwarding: ",
            "  Router Interface Name: VLAN0001",
            "  IP Address: 10.5.28.111/24",
            "  Source MAC address: 0012.e26a.015c(System)",
            "  Description: VLAN0001",
            "  Spanning Tree: None(-)",
            "  AXRP RING ID:       AXRP VLAN group:",
            "  IGMP snooping:      MLD snooping: ",
            "  Untagged(28)  : 0/1-28",
            "  Tagged(0)     :"
        ],
        [
            "Date 1980/04/10 11:02:28 UTC",
            "",
            "    Physical memory = 131072KB(128.00MB)",
            "    Used     memory = 118419KB(115.64MB)",
            "    Free     memory =  12653KB( 12.36MB)"
        ],
        [
            "Date 1980/04/10 11:02:28 UTC",
            " Last NTP Status",
            "  There is no updating information.",
            "",
            " Activate NTP Client",
            "  NTP-Server : ---, Source-Address : ---",
            "  Mode : Command",
            "",
            " NTP Execute History(Max 10 entry)",
            "  There is no history information."
        ]
    ]
```

SSH経由で取得した場合とコンソール経由で取得した場合とで、相違ないことがわかります。
> diffまではしなくてよいかと。。。

[→演習4.1 オペミスからの復旧自動化](/4.1-automation_of_operation_error_recovery.md)  
[←演習3.3 ALAXALA装置の設定情報を取得する](/3.3-get_alaxala_device_information.md)   
[↑目次に戻る](/README.md)
