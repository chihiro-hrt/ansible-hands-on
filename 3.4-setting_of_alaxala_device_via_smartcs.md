[↑目次に戻る](/README.md)
<br>
# 演習3.4　ALAXALA装置の設定情報をSmartCS経由で取得する

演習3.3でax_commandを使ってALAXALA装置から設定情報を取得するPlaybookを作成しました。    
作成したPlaybookの内容を一部変更して、SmartCS経由（コンソール経由）で同様の情報を取得するPlaybookを作成します。

## 目次
本演習では以下を行います。  
- STEP1.ログイン用、ログアウト用のPlaybookを作成する  
- STEP2.<code>ax_command</code>をSmartCS経由で動作させるように変更する
- STEP3.作成した3つのPlaybookを1回のコマンドで実行する(includeの利用)  


## 演習概要図

> あとで描く

### STEP1. ログイン用、ログアウト用のPlaybookを作成する。

通常のモジュール(ax_command等)は、SSH経由で装置にログインして情報を取得しますが、コンソール経由で接続をする場合  
- コンソールからのログイン  
- コンソールからのログアウト  
の処理を行う必要があります。

演習3.1で作成したPlaybookと同様 コンソール経由でオペレーションした場合、  
ログイン時は以下のような入出力、Playbookとなります。  

■ログイン時  
＜入出力＞
```
login: alaxala
Password: 

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230> 
```
＜Playbook＞
```
---
- name: '3-4 step1 login'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      recvchar:
      - 'login: '
      - 'Password: '
      - 'AX2230> '
      sendchar:
      - 'alaxala'
      - 'secret2230'
```

ログアウト時は以下のような入出力、Playbookとなります。  


■ログアウト時  
＜入出力＞
```
AX2230> exit

login: 
```
＜Playbook＞
```
---
- name: '3-1 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      recvchar:
      - 'login: '
      - 'AX2230> '
      sendchar:
      - 'exit'
      - 'exit'
```

### STEP2. ax_commandをSmartCS経由で動作させるように変更する

実際の処理部分のPlaybookを作成します。  
演習3.3の<code>ax_command</code>とtask部分は同じですが、<code>hosts</code>と<code>vars</code>に指定する値が変わります。

Playbook  
```
---
- name: '3-4 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301

  tasks:
  - name: "ax_command"
    ax_command:
      commands:
      - show version
      - show ip route
      - show vlan 1
      - show memory summary 
      - show ntp-client

```
解説  
- hosts: NS2250  
SmartCS経由で接続を行うため、接続先をNS2250と指定します。
- ansible_user: userX 
SmartCS経由で接続を行うため、ログインユーザにSmartCSのポートアクセス用ユーザ名<code>port1</code>を指定します。
- ansible_password: userX  
SmartCS経由で接続を行うため、ログインユーザのパスワードをSmartCSのポートアクセス用ユーザのパスワード<code>port1</code>を指定します。  
- ansible_port: 9301  
SmartCS経由で接続を行うため、専用のポート番号に指定します。  


### STEP3. 作成した3つのPlaybookを1回のコマンドで実行する(includeの利用)  

STEP1、STEP2 で作成した3つのPlaybookを1回のコマンドで実行できるようなPlaybookを作成します。
複数のPlaybookを集約する為、<code>import_playbook</code>を利用します。

Playbook
```
---
- name: "login"
  import_playbook: 3.4_step1_login.yml

- name: "ax_command via console"
  import_playbook: 3.4_step2_operation.yml

- name: "logout"
  import_playbook: 3.4_step1_logout.yml
```


実行結果を演習3.3と比較するなどしてもいいかも


[→演習4.1 オペミスからの復旧自動化](/4.1-automation_of_operation_error_recovery.md)  
[→目次に戻る](/README.md)
