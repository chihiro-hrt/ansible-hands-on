[↑目次に戻る](/README.md)
<br>
# 演習4.1　オペミスからの復旧自動化

演習3でSmartCS経由でALAXALA装置にAnsibleを介してオペレーションを行う方法の演習を行いました。  
演習4では実運用でAnsibleとSmartCSをつかうユースケースの演習を行います。

演習4.1では監視対象のALAXALA装置に対して、オペレーションミスでIPリーチできなくなってしまった場合に  
SmartCSでコンフィグの復旧作業を行う演習となります。

## 目次
本演習では以下を行います。  
- STEP1.オペレーションミスを起こす（ALAXALA装置の設定を意図的に変更する
- STEP2.コンソール（SmartCS）経由で設定情報を取得する
- STEP3.コンソール（SmartCS）経由で設定を復旧させる


## 演習概要図

> あとで描く


### STEP1.オペレーションミスを起こす（ALAXALA装置の設定を意図的に変更する

※ひとまず暫定的に以下のPlaybook作成しました。
> できればもう少しいいオペミス内容に変更したいですが、ひとまず  
Playbook例
```
  tasks:
  - name: "miss operation"
    ax_config:
      lines: shutdown
      parents: interface gigabitethernet 0/1 
      save_when: always
```
> ALAXALA様に要確認

Playbook実行結果  
以下の通りエラーとなります。（途中のInterfaceがDownした為）
```
TASK [ax_config] ***************************************************************************
An exception occurred during task execution. To see the full traceback, use -vvv. 
The error was: ansible.module_utils.connection.ConnectionError: timeout value 30 seconds reached while trying to send command: b'shutdown'
＝＞
　shutdown コマンド送信したら、Timeout時間経過しても期待した実行結果を得られず、
  Playbookが終了してしまった、という内容のエラー。
```

Ansibleホストよりpingを実行しても、SSH接続を試みてもNGとなります。
```
$ ping 10.5.28.111
PING 10.5.28.111 (10.5.28.111) 56(84) bytes of data.
応答なし
^C
--- 10.5.28.111 ping statistics ---
10 packets transmitted, 0 received, 100% packet loss, time 8999ms

$ ssh alaxala@10.5.28.111
応答なし
^C
$ 
```

### STEP2.コンソール（SmartCS）経由で設定情報を取得する

演習3.4で作成したPlaybookを流用して、SmartCS経由でALAXALA装置の設定情報を取得するPlaybookを作成します。  
・ログイン用、ログアウト用は同じPlaybookを使用します。  
・オペレーション用のPlaybookのみ内容に以下を追加します。。  

Playbook  
```
---
- name: '4-1 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301

  tasks:
  - name: "ax_command"
    ax_command:
      commands:
      - set terminal pager disable
      - show logging search down
      - show ip interface 
    register: result

  - name: "register stdout_lines_custom"
    debug:
      msg: "{{ result.stdout_lines[2] }}"
```

Playbook実行結果抜粋（registerの内容）
```
抜粋
    "msg": [
        "Date 1980/04/13 08:24:55 UTC",
        "VLAN0001: Down",
        "mtu 1500",
        "  inet 10.5.28.111/24                 broadcast 10.5.28.255",
        "    Port 0/1 : Down media -                          0012.e26a.015c ",
        "    Port 0/2 : Down media -                          0012.e26a.015c ",
        "    Port 0/28: Down media -                          0012.e26a.015c ",
        "  Time-since-last-status-change: 0day 00:56:37",
        "  Last down at: 1980/04/13 07:28:18",
        "  VLAN: 1"
    ]
```

実行結果より、VLAN0001 がDOWN状態という事が分かりました。


STEP3.コンソール（SmartCS）経由で設定を復旧させる

本演習では意図的に設定変更を行い、ALAXALA装置と通信できない状態としています。  
実環境では復旧の為の明確な方法が分からない中、早く通信できる状態にする必要があるかと思います。

復旧の為、初期構築用のPlaybook、及び追加設定のPlaybookを再度流し込みます。
演習3.1で作成した初期構築用のPlaybookは、<code>smartcs_tty_command</code>を使用している為、  
<code>ax_config</code>を利用したPlaybookを改めて作成します。

Playbook  
```
---
- name: '4-1 step3'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301
  - ansible_become: yes 
  - ansible_become_method: enable
  - ansible_become_pass: 'secret2230'

  tasks:
  - name: "interface gigabitethernet 0/1"
    ax_config:
      lines: no shutdown
      parents: interface gigabitethernet 0/1
      save_when: changed
  
  - name: "interface vlan1"
    ax_config:
      lines: ip address 10.5.28.111 255.255.255.0
      parents: interface vlan 1
      save_when: changed
  
  - name: "other"
    ax_config:
      lines: 
      - ip route 0.0.0.0 0.0.0.0 10.5.28.1 
      - ip ssh
      save_when: changed
```
> ログインユーザの変更、パスワード変更、enable-passwordの変更もPlaybook化したい。  
> Playbookの精査は後回し  
> 本当はこの後演習3.2で作成した追加設定も投入する。  
> このPlaybookは、演習4.Xのこの後の演習でも復旧用Playbookとして使いまわす予定。  


設定が復旧して、ALAXALA装置にログインできるかどうかを認してみます。
```
$ ping -c 3 10.5.28.111
PING 10.5.28.111 (10.5.28.111) 56(84) bytes of data.
64 bytes from 10.5.28.111: icmp_seq=1 ttl=63 time=1.14 ms
64 bytes from 10.5.28.111: icmp_seq=2 ttl=63 time=1.93 ms
64 bytes from 10.5.28.111: icmp_seq=3 ttl=63 time=1.19 ms

--- 10.5.28.111 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 1.147/1.425/1.935/0.361 ms
$ 
$ ssh alaxala@10.5.28.111
alaxala@10.5.28.111's password: 
$ 
```






[→演習4.2 通信障害からの復旧自動化](/4.2-automation_of_recovery_from_network_communication_failures.md)  
[←演習3.4　ALAXALA装置の設定情報をSmartCS経由で取得する](/3.4-setting_of_alaxala_device_via_smartcs.md)   
[↑目次に戻る](/README.md)
