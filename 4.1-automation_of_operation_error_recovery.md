[↑目次に戻る](/README.md)
<br>
# 演習4.1　オペミスからの復旧自動化

演習3でSmartCS経由でALAXALA装置にAnsibleを介してオペレーションを行う方法の演習を行いました。  
演習4ではAnsibleとSmartCSを連携した実際のユースケースについて演習を行います。


演習4.1は監視対象のALAXALA装置に対して、オペレーションミスでIPリーチができなくなってしまった場合に  
SmartCSで情報取得を行い、コンフィグの復旧作業を行う演習となります。

## 目次
本演習では以下を行います。  
- STEP1.オペレーションミスを起こす（ALAXALA装置のACL設定を変更する）
- STEP2.コンソール（SmartCS）経由で設定情報を取得する
- STEP3.コンソール（SmartCS）経由で設定を復旧させる


## 演習概要図

> あとで描く


### STEP1.オペレーションミスを起こす（ALAXALA装置の設定を意図的に変更する）

演習3.2でALAXALA装置に対してACLの設定を行いました。  
設定内容  
```
AX2230# show running-config 抜粋 
抜粋
!
interface vlan 1 
  ip access-group "TEST" in 
  ip address 10.5.28.111 255.255.255.0 
!
ip access-list standard "TEST" 
  10 permit host 10.208.39.26 
  20 deny any 
!
```
設定内容として、Ansibleホストである 10.208.39.26 からのみアクセスを受け付ける状態となっています。  
access-list ID を vlan 1 に紐づけている状態  

オペレーションミスの例として、ACLの設定変更を誤って投入してみます。
Playbook
```
  tasks:
  - name: "misstake in changing acl configration"
    ax_config:
      lines:
      - 10 permit host 10.208.39.25 <--- 10エントリ目のエントリを別のIPで誤って上書き
      - 20 deny deny
      parents: ip access-list standard "TEST"
      save_when: changed
```
> ALAXALA様に要確認

Playbook実行結果  
```
ansible.module_utils.connection.ConnectionError: None\n",
    "module_stdout": "",
    "msg": "MODULE FAILURE\nSee stdout/stderr for the exact error",
    "rc": 1
```
ACLは投入直後すぐに反映されてしまう為、SSH経由で設定が投入された直後から<code>permit host ～</code>で指定したホスト以外の通信が遮断され  
SSH接続断となります。  
その為、Playbook実行が上記の通りエラーとなってしまいます。

Ansibleホストよりpingを実行しても、SSH接続を試みてもNGとなります。
```
$ ssh alaxala@10.5.28.111
ssh: connect to host 10.5.28.111 port 22: Connection timed out
$ ping 10.5.28.111
PING 10.5.28.111 (10.5.28.111) 56(84) bytes of data.
^C
--- 10.5.28.111 ping statistics ---
9 packets transmitted, 0 received, 100% packet loss, time 7999ms
※応答なし
$ 
```
> もともとのACL設定で、AnsibleホストからのSSH接続だけ有効にして、  
> pingは通るけどSSH接続できない状態でもいい気がしますので後で修正するかも

このオペレーションミスにより、ALAXALA装置にアクセスできない状態を意図的に用意する事ができました。


### STEP2.コンソール（SmartCS）経由で設定情報を取得する

演習3.4で作成したPlaybookを流用して、SmartCS経由でALAXALA装置の設定情報を取得するPlaybookを作成します。  
・ログイン用、ログアウト用は同じPlaybookを使用します。  
・オペレーション用のPlaybookのみ内容を変更し、<code>show running-config</code>を実行します。  

Playbook  
```
---
- name: '4-1 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301

  tasks:
  - name: "ax_command"
    ax_command:
      commands:
      - show running-config
    register: result

  - name: "register stdout_lines_custom"
    debug:
      msg: "{{ result.stdout_lines[0] }}"
```

Playbook実行結果抜粋（registerの内容）
```
抜粋
    "msg": [
        "interface vlan 1 ",
        "",
        "  ip access-group \"TEST\" in ",
        "",
        "  ip address 10.5.28.111 255.255.255.0 ",
        "",
        "!",
        "",
        "ip route 0.0.0.0 0.0.0.0 10.5.28.1 ",
        "",
        "!",
        "",
        "ip access-list standard \"TEST\" ",
        "",
        "  10 permit host 10.208.39.25 ",
        "",
        "  20 deny any ",
    ]
```

実行結果より、<code>ip access-list standard "TEST"</code>の10エントリに誤りがあり、  
Ansibleホストと異なるIPで上書きしてしまったことが分かりました。


### STEP3.コンソール（SmartCS）経由で設定を復旧させる


復旧の為、初期構築用のPlaybook、及び追加設定のPlaybookを再度流し込みます。
演習3.1で作成した初期構築用のPlaybookは、<code>smartcs_tty_command</code>を使用している為、  
<code>ax_config</code>を利用したPlaybookを改めて作成します。

Playbook  
```
---
- name: '4-1 step3'
  hosts: NS2250

  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_user: port1
  - ansible_password: port1
  - ansible_port: 9301
  - ansible_become: yes
  - ansible_become_method: enable
  - ansible_become_pass: 'secret2230'

  tasks:
  - name: "ip access-list standard TEST"
    ax_config:
      lines:
      - 10 permit host 10.208.39.26
      - 20 deny any      parents: ip access-list standard "TEST"      save_when: changed
```
> 演習3.2で作成した ax_config の hostsとvarsを変えたPlaybookを全て再投入した方がいいかもしれません。
> ひとまず、上記はACL設定だけ修正したPlaybookとなります。  

実行結果
```
TASK [ip access-list standard TEST] **********************************************************************
changed: [10.5.31.27]

```


設定が復旧して、ALAXALA装置にログインできるかどうかを認してみます。
```
$ ping -c 3 10.5.28.111
PING 10.5.28.111 (10.5.28.111) 56(84) bytes of data.
64 bytes from 10.5.28.111: icmp_seq=1 ttl=63 time=2.70 ms
64 bytes from 10.5.28.111: icmp_seq=2 ttl=63 time=12.6 ms
64 bytes from 10.5.28.111: icmp_seq=3 ttl=63 time=22.7 ms

--- 10.5.28.111 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 2.704/12.697/22.729/8.175 ms
$ ssh -l alaxala 10.5.28.111
alaxala@10.5.28.111's password: 
Permission denied, please try again.
alaxala@10.5.28.111's password: 

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230>
$ 
```

無事アクセスできるようになり、設定投入ミスの修正が完了しました。


## 本演習のまとめ

- コンソール（SmartCS）経由の通信路を確保しておく事で、万が一オペレーションミスを起こしてしまっても修正が容易に行えます。  
- 初期設定、追加設定 の内容を Playbook化 する事でAnsible経由で復旧作業を自動化する事ができます。  



[→演習4.2 通信障害からの復旧自動化](/4.2-automation_of_recovery_from_network_communication_failures.md)  
[←演習3.4　ALAXALA装置の設定情報をSmartCS経由で取得する](/3.4-setting_of_alaxala_device_via_smartcs.md)   
[↑目次に戻る](/README.md)
