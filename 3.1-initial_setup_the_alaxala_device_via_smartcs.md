[↑目次に戻る](/README.md)
<br>
# 演習3.1　ALAXALA装置にSmartCS経由で初期設定を行う

## 目次
本演習では以下を行います。 
- STEP1. smartcs_tty_command 使ったPlaybookを作成する
- STEP2. smartcs_tty_command を実行し、ALAXALA装置に初期設定を行う

## 演習概要図

> あとで描く

### STEP1. smartcs_tty_command 使ったPlaybookを作成する

まずは、<code>smartcs_tty_command</code>を使ってPlaybookを作成を練習してみます。
ALAXALA装置にコンソール経由でログインして<code>show version</code>を実行するPlaybookを作成してみます。

> MEMO  
> 初期状態から始める予定なので、Passwordとか聞かれないかも

実際のコンソールの入出力は以下のようなオペレーションとなります。
<br>

```
login: operator

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230> show version

Date 1980/04/10 03:41:23 UTC
Model: AX2230S-24T
S/W: OS-LT4 Ver. 2.10 (Build:01)
H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]

AX2230> exit

login: 
```
オペレーション内容の説明
ログインID（operator）、パスワード(Network)を入力してログイン後、<code>show version</code>を実行します。  
その後、<code>exit</code>コマンドを実行してログアウトします。
> ID、Passは正式版に変更する必要有
<br>

これを<code>smartcs_tty_command</code>を使ってPlaybook化した場合、以下のような内容となります。
<br>
```
---
- name: '3-1 step1'
  hosts: NS2250_Handson
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      recvchar:
      - 'login: '
      - 'AX2230> '
      sendchar:
      - 'operator'
      - 'show version'
      - 'exit'
```
Playbook内容（モジュールオプション）の説明(1)
- tty:  
コンソール経由で操作したいターゲットが接続されているtty番号を指定します。
- recvchar:  
<code>sendchar</code>オプションで送信した文字列を送信後、待ち受ける文字列を指定します。
- sendchar:  
リストの上から指定した文字列を指定します。
> hostsとvarsはあとできちんと定義  
<br>

<code>smartcs_tty_command</code>は、上記のように<code>recvchar</code>、<code>sendchar</code>オプションを使ってコンソールに対して送受信する文字列を制御するモジュールとなります。このモジュールを使う事で、SmartCSに接続されているネットワーク機器について、専用のモジュールが用意されていなくてもAnsible経由でのアクセスが可能となります。



### STEP2. smartcs_tty_command を実行し、ALAXALA装置に初期設定を行う

<code>smartcs_tty_command</code>を使ってALAXALA装置の初期構築を行うPlaybookを作成します。  
IP設定などの初期構築（Ansibleからアクセスする為のコンフィグ投入）をコンソール経由で行う場合、以下のようなオペレーション内容となります。
<br>
```
login: operator

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

AX2230> enable
AX2230# rename user
Changing username.
Old username:operator
New username:alaxala
AX2230# password
Changing local password for alaxala.
New password:
Retype new password:
AX2230# password enable-mode 
Changing local password for admin.
New password:
Retype new password:
AX2230# configure 
AX2230(config)# line vty 0 1
!AX2230(config-line)# exit
!AX2230(config)# interface vlan 1
!AX2230(config-if)# ip address 10.5.28.111 255.255.255.0
!AX2230(config-if)# exit
!AX2230(config)# ip route 0.0.0.0 0.0.0.0 10.5.28.1 
!AX2230(config)# ip ssh
!AX2230(config)# write
AX2230(config)# exit
AX2230# exit
login: 
```
オペレーション内容の説明  
あとで書く
> 詳細はALAXALA様に確認予定  
> IPなども環境決まり次第ちゃんと整備
<br>

上記のコンソールオペレーションを<code>smartcs_tty_command</code>を使ってPlaybook化すると
以下のようなPlaybookとなります。
<br>
```
---
- name: '3-1 step2'
  hosts: NS2250
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: smartcs
  
  tasks:
  - name: "smartcs_tty_command"
    smartcs_tty_command:
      tty: '1'
      custom_response: on
      custom_response_delete_nl: on
      recvchar:
      - 'login: '
      - 'Password: '
      - 'Old username:'
      - 'New username:'
      - 'New password:'
      - 'Retype new password:'
      - 'AX2230> '
      - 'AX2230# '
      - 'AX2230(config)# '
      - '!AX2230(config)# '
      - '!AX2230(config-line)# '
      - '!AX2230(config-if)# '
      sendchar:
      - 'operator'
      - 'enable'
      - 'rename user'
      - 'operator'
      - 'alaxala'
      - 'password'
      - 'secret2230'
      - 'secret2230'
      - 'password enable-mode'
      - 'secret2230'
      - 'secret2230'
      - 'configure'
      - 'line vty 0 1'
      - 'transport input all'
      - 'exit'
      - 'interface vlan 1'
      - 'ip address 10.5.28.111 255.255.255.0'
      - 'exit'
      - 'ip route 0.0.0.0 0.0.0.0 10.5.28.1'
      - 'ip ssh'
      - 'write'
      - 'exit'
      - 'exit'
    register: result

  - name: "register stdout_lines_custom"
    debug:
      msg: "{{ result.stdout_lines_custom }}"

```
Playbook内容（モジュールオプション）の説明(2)
- custom_response: on
通常のstdout、stdout_linesに加え、コンソール経由で送受信した文字列を「送信文字列(executte_command)」「受信文字列(response)」に分けた辞書型の返り値を<code>stdout_lines_custom</code>として追加します。
- custom_response_delete_nl: on 
<code>stdout_lines_custom</code>のresponseに含まれる帰り値のうち、「改行のみ」の表示を削除して見やすくするオプションとなります。  
<br>

表示例
```
    "msg": [
        {
            "execute_command": "operator",
            "response": [
                "Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.",
                "AX2230>"
            ]
        },
        {
            "execute_command": "enable",
            "response": [
                "AX2230#"
            ]
        },
        {
            "execute_command": "rename user",
            "response": [
                "Changing username.",
                "Old username:"
            ]
        },
```





[→演習3.2 ALAXALA装置にSmartCS経由で追加設定を行う](/3.2-additional_setup_the_alaxala_device_via_smartcs.md)    
[↑目次に戻る](/README.md)  

