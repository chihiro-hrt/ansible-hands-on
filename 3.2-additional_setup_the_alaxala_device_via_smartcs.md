[←目次に戻る](/README.md)
<br>
# 演習3.2　ALAXALA装置にSmartCS経由で追加設定を行う

## 目次
本演習では以下を行います。 
- STEP1. <code>ax_facts</code>を使って、ALAXALA装置にAnsibleからアクセスできる事の確認を行う。
- STEP2. <code>ax_config</code>を使ってALAXALA装置に追加設定（VLANの追加）を行う  
- STEP3. <code>ax_config</code>とjinja2 template を組み合わせてALAXALA装置に追加設定(NTP設定の追加)を行う


## 演習概要図

> あとで描く

### STEP1. <code>ax_facts</code>を使って、ALAXALA装置にAnsibleからアクセスできる事の確認を行う。

演習3.1でAnsibleからリーチ可能となったALAXALA機器に対して、<code>ax_facts</code>を使って接続確認を行います。

接続確認を行うPlaybookは以下となります。
<br>

```
---
- name: 3-2 step1: ax_facts
  hosts: ax
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_become: yes
  - ansible_become_method: enable
  - ansible_become_pass: 'secret2230'

  tasks:
  - name: ax_facts all
    ax_facts:
      gather_subset: all
```
<br>

Playbookが実行され、初期設定を行ったALAXALA装置の情報が取得できます。  
取得情報の抜粋
```
        "ansible_net_memfree_mb": 12,
        "ansible_net_memtotal_mb": 128,
        "ansible_net_model": "AX2230S-24T",
        "ansible_net_python_version": "2.7.5",
        "ansible_net_serialnum": "CA022B24T000S0000C7S013:0",
        "ansible_net_system": "ax",
        "ansible_net_version": "2.10"
```


### STEP2. <code>ax_config</code>を使ってALAXALA装置に追加設定（VLANの追加）を行う  

次は<code>ax_config</code>を使って追加の設定を行います。
設定する内容は以下となります。
- VLANの追加  


上記を設定するPlaybookは以下となります。
<br>
```
---
- name: 3-2 step2 configure vlan interface and attach to port
  hosts: ax
  
  vars:
  - ansible_connection: network_cli
  - ansible_network_os: ax
  - ansible_become: yes
  - ansible_become_method: enable
  - ansible_become_pass: 'secret2230'
  - vid: '2000'
  - ipaddr: '192.168.0.1'
  - netmask: '255.255.255.0'
  - portif : '0/2'

  tasks:
  - name: configure vlan
    ax_config:
      lines:
      - 'vlan {{ vid }}'
  
  - name: configure interface vlan <vid>
    ax_config:
      lines:
      - 'ip address {{ ipaddr }} {{ netmask }}'
      parents: 'interface vlan {{ vid }}'
  
  - name: vlan configuration to port
    ax_config:
      lines:
      - 'switchport mode trunk'
      - 'switchport trunk allowed vlan add {{ vid }}'
      parents: 'interface gigabitethernet {{ portif }}'
      save_when: modified
```

<br>
Playbook内容（モジュールオプション）の説明
ax_config:  
実行するモジュールとしてax_configを指定します。

lines:  
- vlan {{ vid }}  
ax_configのオプションです。ネットワーク装置に設定するコンフィグレーションのリストを設定します。この例では、VLAN設定のコンフィグレーションリストを設定しています。VLAN番号はステップ1で作成した変数vidを参照しています。  

lines:  
- ip address {{ ipaddr }} {{ netmask }}
ネットワーク装置にIPアドレスとサブネットマスクを設定しています。IPアドレスとサブネットマスクはステップ1で作成した変数ipaddrとnetmaskを参照しています。  

parents: "interface vlan {{ vid }}"  
ax_configのオプションです。linesオプションで設定したコンフィグレーションリストを設定する階層のリストを設定します。IPアドレスとサブネットマスクを設定する階層として、interface vlan {{ vid }}を設定しています。VLAN番号はステップ1で作成した変数vidを参照しています。  

lines:  
- switchport mode trunk  
インタフェースをトランクモードに設定しています。  
parents: "interface gigabitethernet {{ port }}"  
トランクモードを設定する階層として、interface gigabitethernet {{ port }}を指定しています。ポート番号はステップ1で作成したportを参照しています。  
lines:  
- switchport trunk allowed vlan add {{ vid }}  
トランクポートにVLANを追加しています。追加するVLANのVLAN番号はステップ1で作成した変数vidを参照しています。  

parents: "interface gigabitethernet {{ port }}"  
VLANを追加する階層として、interface gigabitethernet {{ port }}を指定しています。ポート番号はステップ1で作成したportを参照しています。  

save_when: modified  
コンフィグレーションの保存方式を指定するオプションです。この例ではmodifiedを指定しています。modifiedを指定した場合、ランニングコンフィグとスタートアップコンフィグを比較して差分があるときにコンフィグレーションを保存します。  



### STEP3. <code>ax_config</code>とjinja2 template を組み合わせてALAXALA装置に追加設定(NTP設定の追加)を行う




- この演習内容がちょっと寂しいので、何か追加したい。  
  一般的なネットワーク機器の追加設定を一通り入れるイメージか。（NTP、ACL等々）
- F5さんやALAXALAさんのハンズオン資料を参考にしてみてあとで追記予定。  
- ネットワーク機器に設定投入する際のテクニック的な演習を織り交ぜてもいいのかもしれません、  
  loop処理とかかな。(routeエントリ とか hostsエントリ とか)
- あとは、冪等性の確認とかでしょうか。
- 設定したコンフィグ情報を最後に取得してローカル（Ansibleホストに保存）とかもいいかもしれません。

[→演習3.3 ALAXALA装置の設定情報を取得する](/3.3-get_alaxala_device_information.md)    
[←演習3.1 ALAXALA装置にSmartCS経由で初期設定を行う](/3.1-initial_setup_the_alaxala_device_via_smartcs.md)    
[↑目次に戻る](/README.md)  

