[↑目次に戻る](/README.md)
<br>
# 演習4.3　ファームウェアアップデートの自動化


演習4.3ではSmartCSに接続されている機器のファームウェアアップデートを行う演習を行います。  
バージョンアップ作業はオペレーションにreload/rebootといった再起動処理が含まれる事が多い為、  
SSH経由で作業しにくいオペレーションとなりますが、  
SmartCS経由でアップデートを行う事で、万が一の場合も安心して作業することができます。  

## 目次
本演習では以下を行います。  
- STEP1.ALAXALA装置のファームウェアアップデート手順を確認する。
- STEP2.SmartCSとALAXALAのモジュールを連携して、ALAXALA装置のファームウェアアップデートを行う。

## 演習概要図

> あとで描く

<br>
<br>


### STEP1.ALAXALA装置のファームウェアアップデート手順の確認

まず、ALAXALA装置（AX2230）のF/Wバージョンアップ手順について確認します。
あらかじめ、FTPサーバ上にファームウェアのイメージがある事を確認しておきます。
<br>
```
$ ls -l /home/xxxxx/AX2230L20210-01.bin 
-rw-r--r-- 1 xxxxx xxxxx 6503284  1月 10 19:15 /home/xxxxx/AX2230L20210-01.bin
$ 
```
<br>

(1)現在のシステムバージョン情報を確認する  
<br>
```
> show version

Date 1980/05/01 08:26:52 UTC
Model: AX2230S-24T
S/W: OS-LT4 Ver. 2.9 (Build:04)
H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]

>
```

(2)バージョンアップイメージをFTPコマンドで取得し、ファームウェアのバージョンアップを行う  
<br>
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

> enable
Password:
#
# ftp x.x.x.x
Connecting...

220 (vsFTPd 3.0.2)
Name: user
331 Please specify the password.
Password:
230 Login successful.
ftp> binary
Type: binary
ftp> cd /home/user
250 Directory successfully changed.
ftp> get AX2230L20210-01.bin k.img
200 Switching to Binary mode.
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for AX2230L20210-01.bin (6503284 bytes).
226 Transfer complete.
ftp> quit
#
# ppupdate ramdisk k.img

Software update start
***********************************************
** UPDATE IS STARTED.                        **
***********************************************

old version 2.9 (Build:04)
new version 2.10 (Build:01)

Automatic reboot process will be run after installation process.
Do you wish to continue? (y/n): y

Main      : [************************************************]100%

Update done.
***********************************************
** UPDATE IS FINISHED SUCCESSFULLY.          **
***********************************************

Please wait a few minutes. The reload command is executing.



Boot Initialize.......done.
System Initialize....done.

login:
```
<br>

(3)バージョンアップ後のシステムバージョンを確認する
<br>
```
> show ramdisk-file

Date 1980/05/01 03:58:19 UTC
Model: AX2230S-24T
S/W: OS-LT4 Ver. 2.10 (Build:01)
H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]

>
```
<br>
<br>

手動でファームウェアのバージョンアップ作業を行う場合、このようなオペレーションとなります。

<br>
<br>

### STEP2.SmartCSとALAXALAのモジュールを連携して、ALAXALA装置のファームウェアアップデートを行う。


STEP1で確認したバージョンアップ作業をPlaybook化します。
<code>ax_command</code>と<code>smartcs_tty_command</code>を利用します。

|手順|使用モジュール|
|:---|:---|:---|
|(1)現在のシステムバージョン情報を確認する |ax_command | 
|(2)バージョンアップイメージをFTPコマンドで取得し、ファームウェアのバージョンアップを行う |smartcs_tty_command |
|(3)バージョンアップ後のシステムバージョンを確認する |ax_command |

#### (1)現在のシステムバージョン情報を確認する 

#### (2)バージョンアップイメージをFTPコマンドで取得し、ファームウェアのバージョンアップを行う

#### (3)バージョンアップ後のシステムバージョンを確認する

#### 複数のPlaybookをまとめる



メモ  
- ax_command をSmartCSを介してF/Wアップデートする  
- smartc_tty_command のタイムアウト値は長くする  
- 従来のax_commandだけで実行する場合よりも、実行中の入出力がすべてAnsible実行ログに残る事がメリット という感じで締める  


[→演習4.4 初期化の自動化](/4.4-automation_of_initialization.md)  
[←演習4.2 通信障害からの復旧自動化](/4.2-automation_of_recovery_from_network_communication_failures.md)  
[↑目次に戻る](/README.md)
