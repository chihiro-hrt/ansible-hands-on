[→目次に戻る](/README.md)
<br>
# 演習4.3　ファームウェアアップデートの自動化


演習4.3ではSmartCSに接続されている機器のファームウェアアップデートを行う演習となります。  
バージョンアップ作業はオペレーションにreboot手順などが含まれる事が多い為、SSH経由で作業しにくいですが、  
コンソール（SmartCS）経由の場合、万が一の場合も安心して作業することができます。

## 目次
本演習では以下を行います。  
- STEP1.AnsibleとSmartCSを連携して、ALAXALA装置のファームウェアアップデートを行う。
- STEP2.バージョンアップ後の確認を行う。  

## 演習概要図

> あとで描く

<br>
<br>


### STEP1.ALAXALA装置のファームウェアアップデート手順の確認

まず、ALAXALA装置（AX2230）のF/Wバージョンアップ手順について確認します。

(1)バージョンアップイメージのファイル名を変更する
<br>
```
$ cp AX2230L20210-01.bin k.img
$ ls -l
合計 12704
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:23 AX2230L20210-01.bin
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:38 k.img
$ 
```
<br>

(2)バージョンアップイメージを装置に送信する
<br>
```
$ sftp alaxala@ax
alaxala@ax's password: 
Connected to ax.
sftp> lls -l
合計 12704
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:23 AX2230L20210-01.bin
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:38 k.img
sftp> put k.img
Uploading k.img to /ramdisk/k.img
k.img                                                                    100% 6351KB 608.6KB/s   00:10    
sftp> ls -l
-rwxrwxrwx   1 0    0    6503284  2019-05-02 12:22 k.img
sftp> exit
$ 
```
<br>

(3)送信したファイル内容を確認する
<br>
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

> enable
Password:
# show ramdisk-file

Date 1980/04/29 23:33:24 UTC
    File Date               Size Name
    2019/05/02 12:22   6,503,284 k.img

#
```
<br>

(4)アップデートを実行する
<br>
```
# ppupdate ramdisk k.img

Software update start
***********************************************
** UPDATE IS STARTED.                        **
***********************************************

old version 2.10 (Build:01)
new version 2.10 (Build:01)

Automatic reboot process will be run after installation process.
Do you wish to continue? (y/n): y

Main      : [************************************************]100%

Update done.
***********************************************
** UPDATE IS FINISHED SUCCESSFULLY.          **
***********************************************

Please wait a few minutes. The reload command is executing.



Boot Initialize.......done.
System Initialize....done.

login:
```
<br>

(5)アップデート完了後、正しくバージョンアップされている事を確認する
<br>
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

> show version

Date 1980/04/29 23:37:03 UTC
Model: AX2230S-24T
S/W: OS-LT4 Ver. 2.10 (Build:01)
H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]

>
```
<br>

この手順をPlaybook化していきます。  

|手順|使用モジュール|
|:---|:---|
|(1)バージョンアップイメージのファイル名を変更する |copy |
|(2)バージョンアップイメージを装置に送信する。 |net_put |
|(3)送信したファイル内容を確認する |ax_command |
|(4)アップデートを実行する |smartcs_tty_command |
|(5)アップデート完了後、正しくバージョンアップされている事を確認する |ax_command |


今回使用する機器（AX2230）のF/Wアップデート手順が分かればPlaybook化できる。

### STEP2.AnsibleとSmartCSを連携して、ALAXALA装置のファームウェアアップデートを行う。

想定  
- ax_command をSmartCSを介してF/Wアップデートする  
- タイムアウト処理をそれなりに長くすれば実行できるはず  
- 従来のax_commandだけで実行する場合よりも、実行中の入出力がすべてAnsible実行ログに残る事がメリット という感じで締める  
- きちんとバージョンアップできているかの確認までをPlaybook化した方が多分よいと思われる。　　


[→演習4.4 初期化の自動化](/4.4-automation_of_initialization.md)  
[←演習4.2 通信障害からの復旧自動化](/4.2-automation_of_recovery_from_network_communication_failures.md)  
[↑目次に戻る](/README.md)
