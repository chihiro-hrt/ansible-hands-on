[→目次に戻る](/README.md)
<br>
# 演習4.3　ファームウェアアップデートの自動化


演習4.3ではSmartCSに接続されている機器のファームウェアアップデートを行う演習となります。  
バージョンアップ作業はオペレーションにreboot手順などが含まれる事が多い為、SSH経由で作業しにくいですが、  
コンソール（SmartCS）経由の場合、万が一の場合も安心して作業することができます。

## 目次
本演習では以下を行います。  
- STEP1.ALAXALA装置のファームウェアアップデート手順を確認する。
- STEP2.Ansible、SmartCS、ALAXALAの各モジュールを連携して、ALAXALA装置のファームウェアアップデートを行う。

## 演習概要図

> あとで描く

<br>
<br>


### STEP1.ALAXALA装置のファームウェアアップデート手順の確認

まず、ALAXALA装置（AX2230）のF/Wバージョンアップ手順について確認します。

(1)バージョンアップイメージのファイル名を変更する
<br>
```
$ cp AX2230L20210-01.bin k.img
$ ls -l
合計 12704
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:23 AX2230L20210-01.bin
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:38 k.img
$ 
```
<br>

(2)バージョンアップイメージを装置に送信する
<br>
```
$ sftp alaxala@ax
alaxala@ax's password: 
Connected to ax.
sftp> lls -l
合計 12704
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:23 AX2230L20210-01.bin
-rw-r--r-- 1 nakayama nakayama 6503284  1月  9 10:38 k.img
sftp> put k.img
Uploading k.img to /ramdisk/k.img
k.img                                                                    100% 6351KB 608.6KB/s   00:10    
sftp> ls -l
-rwxrwxrwx   1 0    0    6503284  2019-05-02 12:22 k.img
sftp> exit
$ 
```
<br>

(3)送信したファイル内容を確認する
<br>
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

> enable
Password:
# show ramdisk-file

Date 1980/04/29 23:33:24 UTC
    File Date               Size Name
    2019/05/02 12:22   6,503,284 k.img

#
```
<br>

(4)アップデートを実行する
<br>
```
# ppupdate ramdisk k.img

Software update start
***********************************************
** UPDATE IS STARTED.                        **
***********************************************

old version 2.10 (Build:01)
new version 2.10 (Build:01)

Automatic reboot process will be run after installation process.
Do you wish to continue? (y/n): y

Main      : [************************************************]100%

Update done.
***********************************************
** UPDATE IS FINISHED SUCCESSFULLY.          **
***********************************************

Please wait a few minutes. The reload command is executing.



Boot Initialize.......done.
System Initialize....done.

login:
```
<br>

(5)アップデート完了後、正しくバージョンアップされている事を確認する
<br>
```
login: alaxala
Password:

Copyright (c) 2012-2019 ALAXALA Networks Corporation. All rights reserved.

> show version

Date 1980/04/29 23:37:03 UTC
Model: AX2230S-24T
S/W: OS-LT4 Ver. 2.10 (Build:01)
H/W: AX-2230-24T-B [CA022B24T000S0000C7S013:0]

>
```
<br>

この手順をPlaybook化していきます。  

|手順|使用モジュール|
|:---|:---|
|(1)バージョンアップイメージのファイル名を変更する |copy |
|(2)バージョンアップイメージを装置に送信する。 |net_put |
|(3)送信したファイル内容を確認する |ax_command |
|(4)アップデートを実行する |smartcs_tty_command |
|(5)アップデート完了後、正しくバージョンアップされている事を確認する |ax_command |


<br>
<br>

### STEP2.Ansible、SmartCS、ALAXALAの各モジュールを連携して、ALAXALA装置のファームウェアアップデートを行う。

> 1/9 11:00調査  
> net_put モジュールがうまく動作しない  

Playbook
<br>
```
  hosts: ax    #vars:
  #- ansible_network_os: ax

  tasks:
  - name: sftp put image to network device
    net_put:
      #src: AX2230L20210-01.bin      protocol: sftp      mode: binary
      dest : k.img~                          
```
<br>
実行結果
```
PLAY [4.3-step2 AX2230 FW Versionup] **********************************************************************

TASK [Gathering Facts] ************************************************************************************
task path: /home/nakayama/handson/playbook/4.3/4.3-step2_ax_fw-versionup.yml:2
<ax> ESTABLISH SSH CONNECTION FOR USER: alaxala
<ax> SSH: EXEC sshpass -d11 ssh -C -o ControlMaster=auto -o ControlPersist=60s -o 'User="alaxala"' -o ConnectTimeout=10 -o ControlPath=/home/nakayama/.ansible/cp/2bc49cfd88 ax '/bin/sh -c '"'"'echo ~alaxala && sleep 0'"'"''
<ax> (255, b'', b'')
fatal: [ax]: UNREACHABLE! => {
    "changed": false,
    "msg": "Failed to connect to the host via ssh: ",
    "unreachable": true
}

PLAY RECAP ************************************************************************************************
ax                         : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0   

```


メモ  
- ax_command をSmartCSを介してF/Wアップデートする  
- smartc_tty_command のタイムアウト値は長くする  
- 従来のax_commandだけで実行する場合よりも、実行中の入出力がすべてAnsible実行ログに残る事がメリット という感じで締める  


[→演習4.4 初期化の自動化](/4.4-automation_of_initialization.md)  
[←演習4.2 通信障害からの復旧自動化](/4.2-automation_of_recovery_from_network_communication_failures.md)  
[↑目次に戻る](/README.md)
